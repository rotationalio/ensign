<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Ensign for Data Engineers # We love data engineers — it&rsquo;s how a lot of us got our starts in tech. One of the main reasons we made Ensign is to make it easier for you to put your data in motion. We know that a clumsy ETL routine can quickly turn a data lake into a data landfill.
In this example we&rsquo;ll see how to move data around with Ensign."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Ensign for Data Engineers"><meta property="og:description" content="Ensign for Data Engineers # We love data engineers — it&rsquo;s how a lot of us got our starts in tech. One of the main reasons we made Ensign is to make it easier for you to put your data in motion. We know that a clumsy ETL routine can quickly turn a data lake into a data landfill.
In this example we&rsquo;ll see how to move data around with Ensign."><meta property="og:type" content="article"><meta property="og:url" content="https://ensign.rotational.dev/examples/data_engineers/"><meta property="article:section" content="examples"><meta property="article:modified_time" content="2023-02-03T15:10:23-05:00"><title>Ensign for Data Engineers | Ensign Docs</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.57f59bed6677922e9441fc41df4da3dc906a45058f7c8af184aaf40f7b30f971.css integrity="sha256-V/Wb7WZ3ki6UQfxB302j3JBqRQWPfIrxhKr0D3sw+XE=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.369e11d1ea2273835edf416a47a8f0352c8ed75140376b8a0d12278e402555fb.js integrity="sha256-Np4R0eoic4Ne30FqR6jwNSyO11FAN2uKDRInjkAlVfs=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XMWR6VW3VJ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XMWR6VW3VJ",{anonymize_ip:!1})}</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo><span>Ensign Docs</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/getting-started/>Getting Started</a><ul></ul></li><li><a href=/examples/>End-to-End Examples</a><ul><li><a href=/examples/developers/>Ensign for Application Developers</a></li><li><a href=/examples/data_engineers/ class=active>Ensign for Data Engineers</a></li><li><a href=/examples/data_scientists/>Ensign for Data Scientists</a></li></ul></li><li><a href=/eventing/>Eventing 101</a><ul><li><a href=/eventing/glossary/>Glossary</a></li><li><a href=/eventing/faq/>FAQ</a></li></ul></li><li><a href=/sdk/>SDKs</a><ul></ul></li><li><a href=/system/>System</a><ul><li><a href=/system/configuration/>Configuration</a></li><li><a href=/system/staging/>Staging</a></li></ul></li></ul><ul><li><a href=https://github.com/rotationalio/ensign target=_blank rel=noopener>GitHub</a></li><li><a href=https://rotational.io target=_blank rel=noopener>Rotational Labs</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Ensign for Data Engineers</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#ensign-for-data-engineers>Ensign for Data Engineers</a><ul><li><a href=#etl-design>ETL Design</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#project-setup>Project Setup</a></li><li><a href=#create-the-ensign-publisher>Create the Ensign Publisher</a><ul><li><a href=#call-the-weather-api>Call the Weather API</a></li><li><a href=#publish-the-data-to-a-topic>Publish the Data to a Topic</a></li><li><a href=#start-the-first-stream>Start the First Stream</a></li></ul></li><li><a href=#create-the-ensign-subscriber>Create the Ensign Subscriber</a><ul><li><a href=#connect-to-the-database>Connect to the Database</a></li><li><a href=#does-the-record-exist>Does the Record Exist?</a></li></ul></li><li><a href=#prepping-the-database>Prepping the Database</a><ul><li><a href=#inserting-new-data>Inserting New Data</a></li><li><a href=#start-the-second-stream>Start the Second Stream</a></li></ul></li><li><a href=#composing-our-docker-container>Composing our Docker Container</a></li><li><a href=#lets-gooooooooo>Let&rsquo;s Gooooooooo</a></li><li><a href=#next-steps>Next Steps</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=ensign-for-data-engineers>Ensign for Data Engineers
<a class=anchor href=#ensign-for-data-engineers>#</a></h1><p>We love data engineers — it&rsquo;s how a lot of us got our starts in tech. One of the main reasons we made Ensign is to make it easier for you to put your data in motion. We know that a clumsy ETL routine can quickly turn a data lake into a data landfill.</p><p>In this example we&rsquo;ll see how to move data around with Ensign. We&rsquo;ll be using <a href=https://github.com/rotationalio/watermill-ensign>Watermill-Ensign</a> and <a href=https://watermill.io>Watermill</a> to call a Weather API and insert weather data into a PostgreSQL database. If you haven&rsquo;t used Watermill yet, you&rsquo;re in for a treat! Check out this <a href=https://rotational.io/blog/prototyping-eda-with-watermill/>introductory post</a> that covers the basics.</p><p>Just want the code? Check out this <a href=https://github.com/rotationalio/ensign-examples/tree/main/go/weather_data>repo</a> for the full example.</p><h2 id=etl-design>ETL Design
<a class=anchor href=#etl-design>#</a></h2><p>The architecture for this weather ingestor is composed of three components:</p><ul><li>An Ensign publisher that calls the Weather API and publishes the weather data to a topic.</li><li>An Ensign subscriber that listens on this topic and runs a check against the PostgreSQL database to see if this is a new record. The weather data doesn&rsquo;t change that often, so it is possible to receive a duplicate record. If the record is new, we&rsquo;ll put the record into a second topic.</li><li>A sql publisher that inserts the records from the second topic into the database.</li></ul><p>The Ensign subscriber and the sql publisher are chained together using the <code>router</code> and <code>handler</code> functionality described in <a href=https://rotational.io/blog/prototyping-eda-with-watermill/>this post</a>.</p><h2 id=prerequisites>Prerequisites
<a class=anchor href=#prerequisites>#</a></h2><p>This tutorial assumes that the following steps have been completed:</p><ul><li>You have installed <strong>watermil</strong>, <strong>ensign</strong>, <strong>watermill-ensign</strong>, and <strong>watermill-sql</strong>.</li><li>You have received an Ensign Client ID and Client Secret. Refer to the <a href=https://ensign.rotational.dev/getting-started/>getting started guide</a> on how to obtain the key.</li><li>You have received an API key from the <a href=https://www.weatherapi.com>Weather API website (it&rsquo;s free!)</a>.</li><li>You have <a href=https://www.docker.com/>Docker</a> installed and running on your machine.</li></ul><h2 id=project-setup>Project Setup
<a class=anchor href=#project-setup>#</a></h2><p>First, let&rsquo;s create a root directory <code>weather_data</code> called for the application.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir weather_data
</span></span></code></pre></div><p>We will then create two subfolders, one for the component that calls the Weather API to get the latest weather data and the other for the component that receives the data and inserts it into the database.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd weather_data
</span></span><span style=display:flex><span>mkdir producer
</span></span><span style=display:flex><span>mkdir consumer
</span></span></code></pre></div><h2 id=create-the-ensign-publisher>Create the Ensign Publisher
<a class=anchor href=#create-the-ensign-publisher>#</a></h2><p>Creating a publisher is very straightforward. You will need to have environment variables set up for the Ensign Client ID and Client Secret from <a href=https://ensign.rotational.dev/getting-started/#ensign-keys>your API Key</a>. (<a href=https://rotational.io/ensign/>Need a new key?</a>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>publisher</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ensign</span>.<span style=color:#a6e22e>NewPublisher</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ensign</span>.<span style=color:#a6e22e>PublisherConfig</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>EnsignConfig</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ensign</span>.<span style=color:#a6e22e>Options</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>ClientID</span>:     <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;ENSIGN_CLIENT_ID&#34;</span>),
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>ClientSecret</span>: <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;ENSIGN_CLIENT_SECRET&#34;</span>),
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Marshaler</span>: <span style=color:#a6e22e>ensign</span>.<span style=color:#a6e22e>EventMarshaler</span>{},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>logger</span>,
</span></span><span style=display:flex><span>	)
</span></span></code></pre></div><h3 id=call-the-weather-api>Call the Weather API
<a class=anchor href=#call-the-weather-api>#</a></h3><p>Before we call the Weather API, we need to create the following structs:</p><p>First, a high level struct to represent the updates that come back from the Weather API.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Response</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Current</span> <span style=color:#a6e22e>Current</span> <span style=color:#e6db74>`json:&#34;current,omitempty&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next, a more detailed struct to help us parse all of the components of the Weather API&rsquo;s response. Some of this will depend on how much detail you need to ingest for your downstream data users (will the data scientists on your team complain if you forget to ingest the full text description provided by the response?)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Current</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LastUpdated</span> <span style=color:#66d9ef>string</span>            <span style=color:#e6db74>`json:&#34;last_updated,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>TempF</span>       <span style=color:#66d9ef>float64</span>           <span style=color:#e6db74>`json:&#34;temp_f,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Condition</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>CurrentCondition</span> <span style=color:#e6db74>`json:&#34;condition,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>WindMph</span>     <span style=color:#66d9ef>float64</span>           <span style=color:#e6db74>`json:&#34;wind_mph,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>WindDir</span>     <span style=color:#66d9ef>string</span>            <span style=color:#e6db74>`json:&#34;wind_dir,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PrecipIn</span>    <span style=color:#66d9ef>float64</span>           <span style=color:#e6db74>`json:&#34;precip_in,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Humidity</span>    <span style=color:#66d9ef>int32</span>             <span style=color:#e6db74>`json:&#34;humidity,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>FeelslikeF</span>  <span style=color:#66d9ef>float64</span>           <span style=color:#e6db74>`json:&#34;feelslike_f,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>VisMiles</span>    <span style=color:#66d9ef>float64</span>           <span style=color:#e6db74>`json:&#34;vis_miles,omitempty&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CurrentCondition</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Text</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;text,omitempty&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finally, a struct to represent whatever structure makes the most sense for the weather data in <em>your</em> organization (e.g. with your company&rsquo;s database schemas or use cases in mind):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ApiWeatherInfo</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LastUpdated</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Temperature</span>   <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>FeelsLike</span>     <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Humidity</span>      <span style=color:#66d9ef>int32</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Condition</span>     <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>WindMph</span>       <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>WindDirection</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Visibility</span>    <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Precipitation</span> <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here is the code to create the <code>request</code> object:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#e6db74>&#34;GET&#34;</span>, <span style=color:#e6db74>&#34;http://api.weatherapi.com/v1/current.json?&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span></code></pre></div><p>Next, we will define the query parameters and add it to <code>req</code>. Note that you will need to create an environment variable called <code>WAPIKEY</code> that will be set to the API key you received from the Weather API.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>q</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Query</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;key&#34;</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;WAPIKEY&#34;</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;q&#34;</span>, <span style=color:#e6db74>&#34;Washington DC&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>RawQuery</span> = <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Encode</span>()
</span></span></code></pre></div><p>Let&rsquo;s create the http client to call the Weather API, parse the <code>response</code> object, and create an <code>ApiWeatherInfo</code> object.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#75715e>// create the client object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// retrieve the response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// read the body of the response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// unmarshal the body into a Response object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>body</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>response</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Convert the Response object into a ApiWeatherInfo object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>current</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Current</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>currentWeatherInfo</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ApiWeatherInfo</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastUpdated</span>:   <span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>LastUpdated</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Temperature</span>:   <span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>TempF</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FeelsLike</span>:     <span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>FeelslikeF</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Humidity</span>:      <span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>Humidity</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Condition</span>:     <span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>Condition</span>.<span style=color:#a6e22e>Text</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WindMph</span>:       <span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>WindMph</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WindDirection</span>: <span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>WindDir</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Visibility</span>:    <span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>VisMiles</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Precipitation</span>: <span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>PrecipIn</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here is the complete function with some additional error handling.</p><script src=https://gist.github.com/rebeccabilbro/1c8393527da818171a9b0e7f3f5ce871.js></script><h3 id=publish-the-data-to-a-topic>Publish the Data to a Topic
<a class=anchor href=#publish-the-data-to-a-topic>#</a></h3><p>We&rsquo;ll create a helper method <code>publishWeatherData</code> that takes in a publisher and a channel that is used as a signal to stop publishing. First, create a ticker to call the Weather API every 5 seconds. Next, we will call the <code>GetCurrentWeather</code> function that we constructed previously to retrieve weather data, serialize it, construct a Watermill message, and publish the message to the <code>current_weather</code> topic.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>publishWeatherData</span>(<span style=color:#a6e22e>publisher</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>Publisher</span>, <span style=color:#a6e22e>closeCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>//weather doesn&#39;t change that often - call the Weather API every 5 minutes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ticker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>//if a signal has been sent through closeCh, publisher will stop publishing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>closeCh</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>//call the API to get the weather data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>weatherData</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetCurrentWeather</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Issue retrieving weather data: &#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>//serialize the weather data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>payload</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>weatherData</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Could not marshall weatherData: &#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>//construct a watermill message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>NewMessage</span>(<span style=color:#a6e22e>watermill</span>.<span style=color:#a6e22e>NewUUID</span>(), <span style=color:#a6e22e>payload</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Use a middleware to set the correlation ID, it&#39;s useful for debugging
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>SetCorrelationID</span>(<span style=color:#a6e22e>watermill</span>.<span style=color:#a6e22e>NewShortUUID</span>(), <span style=color:#a6e22e>msg</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>//publish the message to the &#34;current weather&#34; topic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>publisher</span>.<span style=color:#a6e22e>Publish</span>(<span style=color:#e6db74>&#34;current_weather&#34;</span>, <span style=color:#a6e22e>msg</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;cannot publish message: &#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=start-the-first-stream>Start the First Stream
<a class=anchor href=#start-the-first-stream>#</a></h3><p>Next we want to create a long-running process that will continue pinging the Weather API, parsing the response, and publishing it for downstream consumption.</p><p>In our <code>main()</code> function, we will first create a logger using <code>watermill.NewStdLogger</code>. Then we create the publisher and create the <code>closeCh</code> channel that will be used to send a signal to the publisher to stop publishing. We then pass the <code>publisher</code> and the <code>closeCh</code> to the <code>publishWeatherData</code> function and run it in a goroutine.</p><p>We then create another channel that listens for a <code>os.Interrupt</code> signal and will close when it receives the signal. If it receives the signal (e.g. because we want to stop the process, or if something goes wrong), it closes and the code moves on to close the <code>closeCh</code> channel and that notifies the publisher to stop publishing.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// add a logger
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>logger</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>watermill</span>.<span style=color:#a6e22e>NewStdLogger</span>(<span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Starting the producer&#34;</span>, <span style=color:#a6e22e>watermill</span>.<span style=color:#a6e22e>LogFields</span>{})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//create the publisher
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>publisher</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ensign</span>.<span style=color:#a6e22e>NewPublisher</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ensign</span>.<span style=color:#a6e22e>PublisherConfig</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Marshaler</span>: <span style=color:#a6e22e>ensign</span>.<span style=color:#a6e22e>EventMarshaler</span>{},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>logger</span>,
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>publisher</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//used to signal the publisher to stop publishing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>closeCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>publishWeatherData</span>(<span style=color:#a6e22e>publisher</span>, <span style=color:#a6e22e>closeCh</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// wait for SIGINT - this will end processing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Signal</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>signal</span>.<span style=color:#a6e22e>Notify</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Interrupt</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// signal for the publisher to stop publishing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	close(<span style=color:#a6e22e>closeCh</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;All messages published&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=create-the-ensign-subscriber>Create the Ensign Subscriber
<a class=anchor href=#create-the-ensign-subscriber>#</a></h2><p>Next we&rsquo;ll create a subscriber in much the same way as we created our publisher.
Our subscriber will be in charge of listing for incoming weather messages from the publisher, and checking to see if the incoming data is actually new.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>subscriber</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ensign</span>.<span style=color:#a6e22e>NewSubscriber</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ensign</span>.<span style=color:#a6e22e>SubscriberConfig</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>EnsignConfig</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ensign</span>.<span style=color:#a6e22e>Options</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>ClientID</span>:     <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;ENSIGN_CLIENT_ID&#34;</span>),
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>ClientSecret</span>: <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;ENSIGN_CLIENT_SECRET&#34;</span>),
</span></span><span style=display:flex><span>			},
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Unmarshaler</span>: <span style=color:#a6e22e>ensign</span>.<span style=color:#a6e22e>EventMarshaler</span>{},
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>logger</span>,
</span></span><span style=display:flex><span>	)
</span></span></code></pre></div><h3 id=connect-to-the-database>Connect to the Database
<a class=anchor href=#connect-to-the-database>#</a></h3><p>Let&rsquo;s write a quick function <code>createPostgresConnection</code> that will allow us to connect to our database. You will need to create the following environment variables to connect to your local PostgreSQL database: <code>POSTGRES_USER</code>, <code>POSTGRES_PASSWORD</code>, and <code>POSTGRES_DB</code>. You can use any values of your choosing for these variables. For convenience, in this example, we&rsquo;ll use a docker PostgreSQL container. The function is below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createPostgresConnection</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>stdSQL</span>.<span style=color:#a6e22e>DB</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>host</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;weather_db&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>port</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>user</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;POSTGRES_USER&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>password</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;POSTGRES_PASSWORD&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dbname</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;POSTGRES_DB&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dsn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;host=%s port=%d user=%s password=%s dbname=%s sslmode=disable&#34;</span>, <span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>port</span>, <span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>password</span>, <span style=color:#a6e22e>dbname</span>
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>stdSQL</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;postgres&#34;</span>, <span style=color:#a6e22e>dsn</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Ping</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>createQuery</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>`CREATE TABLE IF NOT EXISTS weather_info (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		id SERIAL NOT NULL PRIMARY KEY,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		last_updated VARCHAR(50) NOT NULL,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		temperature DECIMAL,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		feels_like DECIMAL,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		humidity INTEGER,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		condition VARCHAR(36),
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		wind_mph DECIMAL,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		wind_direction VARCHAR(36),
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		visibility DECIMAL,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		precipitation DECIMAL,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		created_at VARCHAR(100) NOT NULL
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	);`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>ExecContext</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>createQuery</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;created table weather_info&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>db</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note that above, the host is defined as <code>weather_db</code> and will match the name of the container. More on that later in the tutorial!</p><p>We will also define a <code>WeatherInfo</code> struct that will contain the fields of the <code>weather_info</code> table. It is similar to the <code>ApiWeatherInfo</code> struct with the exception of the <code>CreatedAt</code>, which is an additional field in the table.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>WeatherInfo</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LastUpdated</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Temperature</span>   <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>FeelsLike</span>     <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Humidity</span>      <span style=color:#66d9ef>int32</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Condition</span>     <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>WindMph</span>       <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>WindDirection</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Visibility</span>    <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Precipitation</span> <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CreatedAt</span>     <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=does-the-record-exist>Does the Record Exist?
<a class=anchor href=#does-the-record-exist>#</a></h3><p>Next, we&rsquo;ll create a function that will check the database to see if the record already exists there. Before we create the function, we need to create a <code>dbHandler</code> struct which implements the <code>stdSQL.DB</code> interface that will be used to query the database.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>dbHandler</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>stdSQL</span>.<span style=color:#a6e22e>DB</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We then write our <code>checkRecordExists</code> function, which will get executed when a message arrives on the <code>current_info</code> topic.</p><p>The first step is to unmarshal the message into a <code>ApiWeatherInfo</code> object. Next we will execute a query to see if a record with the <code>LastUpdated</code> value exists and if it does not, we will create a new <code>WeatherInfo</code> object and add the current timestamp for the <code>CreatedAt</code> field. We will then marshal this object, create, and return a new watermill message which will get published to the <code>weather_info</code> topic. If <code>LastUpdated</code> already exists, we simply note that the record exists and return <code>nil</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>d</span> <span style=color:#a6e22e>dbHandler</span>) <span style=color:#a6e22e>checkRecordExists</span>(<span style=color:#a6e22e>msg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>Message</span>) ([]<span style=color:#f92672>*</span><span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>Message</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>weatherInfo</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ApiWeatherInfo</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Payload</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>weatherInfo</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;received weather info: %+v&#34;</span>, <span style=color:#a6e22e>weatherInfo</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>query</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;SELECT count(*) FROM weather_info WHERE last_updated = $1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>QueryRow</span>(<span style=color:#a6e22e>query</span>, <span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>LastUpdated</span>).<span style=color:#a6e22e>Scan</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>count</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>count</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Found existing record in the database&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#75715e>// not throwing an error here because this is not an issue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>newWeatherInfo</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>WeatherInfo</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>LastUpdated</span>:   <span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>LastUpdated</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Temperature</span>:   <span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>Temperature</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>FeelsLike</span>:     <span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>FeelsLike</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Humidity</span>:      <span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>Humidity</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Condition</span>:     <span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>Condition</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>WindMph</span>:       <span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>WindMph</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>WindDirection</span>: <span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>WindDirection</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Visibility</span>:    <span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>Visibility</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Precipitation</span>: <span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>Precipitation</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>CreatedAt</span>:     <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>String</span>(),
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>newWeatherInfo</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(len(<span style=color:#a6e22e>newWeatherInfo</span>.<span style=color:#a6e22e>CreatedAt</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>payload</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>encoder</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gob</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>payload</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>encoder</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>newWeatherInfo</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>newMessage</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>NewMessage</span>(<span style=color:#a6e22e>watermill</span>.<span style=color:#a6e22e>NewULID</span>(), <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Bytes</span>())
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>Message</span>{<span style=color:#a6e22e>newMessage</span>}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=prepping-the-database>Prepping the Database
<a class=anchor href=#prepping-the-database>#</a></h2><p>Now we need to create a SQL publisher. A SQL publisher is a Watermill implementation of a SQL based pub/sub mechanism whereby you can use publishers to insert or upsert records and you can use subscribers to retrieve records. For more details, refer to this <a href=https://watermill.io/pubsubs/sql/>post</a> on the Watermill site.</p><p>The SQL publisher is created as follows. Note that we are going to set <code>AutoInitializeSchema</code> to <code>false</code> because we&rsquo;ve already created the table. The <code>postgresSchemaAdapter</code> is an extension of Watermill&rsquo;s <code>SchemaAdapter</code> which provides the schema-dependent queries and arguments.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>pub</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>NewPublisher</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>db</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>PublisherConfig</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>SchemaAdapter</span>:        <span style=color:#a6e22e>postgresSchemaAdapter</span>{},
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>AutoInitializeSchema</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>logger</span>,
</span></span><span style=display:flex><span>	)
</span></span></code></pre></div><p>Then we&rsquo;ll create a <code>SchemaInitializingQueries</code> function to make a table based on the topic name, but since we&rsquo;ve already created the table, we&rsquo;ll set this parameter to <code>false</code> and simply return an empty list.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>postgresSchemaAdapter</span>) <span style=color:#a6e22e>SchemaInitializingQueries</span>(<span style=color:#a6e22e>topic</span> <span style=color:#66d9ef>string</span>) []<span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> []<span style=color:#66d9ef>string</span>{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=inserting-new-data>Inserting New Data
<a class=anchor href=#inserting-new-data>#</a></h3><p>Next we will create an <code>InsertQuery</code> function that unmarshals the list of messages and creates an <code>insertQuery</code> sql statement that will be executed. The <code>topic</code> name is the same as the table name and it is used in the <code>insertQuery</code> sql statement. It then extracts the fields of the <code>WeatherInfo</code> object and puts them in the list of <code>args</code>. It then returns the sql statement and the arguments.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>postgresSchemaAdapter</span>) <span style=color:#a6e22e>InsertQuery</span>(<span style=color:#a6e22e>topic</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>msgs</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>Messages</span>) (<span style=color:#66d9ef>string</span>, []<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>insertQuery</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(
</span></span><span style=display:flex><span>		<span style=color:#e6db74>`INSERT INTO %s (last_updated, temperature, feels_like, humidity, condition, wind_mph, wind_direction, visibility, precipitation, created_at) VALUES %s`</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>topic</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimRight</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Repeat</span>(<span style=color:#e6db74>`($1,$2,$3,$4,$5,$6,$7,$8,$9,$10),`</span>, len(<span style=color:#a6e22e>msgs</span>)), <span style=color:#e6db74>&#34;,&#34;</span>),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>args</span> []<span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>msgs</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>weatherInfo</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>WeatherInfo</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>decoder</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gob</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewBuffer</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Payload</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>decoder</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>weatherInfo</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>args</span> = append(
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>args</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>LastUpdated</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>Temperature</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>FeelsLike</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>Humidity</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>Condition</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>WindMph</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>WindDirection</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>Visibility</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>Precipitation</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>weatherInfo</span>.<span style=color:#a6e22e>CreatedAt</span>,
</span></span><span style=display:flex><span>		)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>insertQuery</span>, <span style=color:#a6e22e>args</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here&rsquo;s the part where you&rsquo;d probably set up a subscriber stream for those data scientists who are teaching GPTChat to be more conversant about the weather (or something like that). You&rsquo;ll want to create custom <code>SelectQuery</code> and <code>UnmarshalMessage</code> functions, but since we are not using a SQL subscriber for this tutorial, we&rsquo;ll skip that for now.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>postgresSchemaAdapter</span>) <span style=color:#a6e22e>SelectQuery</span>(<span style=color:#a6e22e>topic</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>consumerGroup</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>offsetsAdapter</span> <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>OffsetsAdapter</span>) (<span style=color:#66d9ef>string</span>, []<span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// No need to implement this method, as PostgreSQL subscriber is not used in this example.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>postgresSchemaAdapter</span>) <span style=color:#a6e22e>UnmarshalMessage</span>(<span style=color:#a6e22e>row</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>stdSQL</span>.<span style=color:#a6e22e>Row</span>) (<span style=color:#a6e22e>offset</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>msg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>Message</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;not implemented&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=start-the-second-stream>Start the Second Stream
<a class=anchor href=#start-the-second-stream>#</a></h3><p>Now we need to put all those last pieces together so that we&rsquo;re storing data back to PostgreSQL.</p><p>Here we will use the router functionality described <a href=https://rotational.io/blog/prototyping-eda-with-watermill/>here</a>. We could have had the Ensign subscriber do the entire work of checking the database and inserting new records and not create a publisher at all. However, by decoupling the checking and the inserting functions, we can enable Ensign to scale up and down them independently, which could save some serious $$$ depending on how much throughput you&rsquo;re dealing with.</p><p>Here, we instantiate a new router, add a <code>SignalsHandler</code> plugin that will shut down the router if it receives a <code>SIGTERM</code> message. We also add a <code>Recoverer</code> middleware which handles any panics sent by the handler.</p><p>Next, we will create the PostgreSQL connection and create the <code>weather_info</code> table. We then create the ensign subscriber and the sql publisher.</p><p>We will then add a handler to the router called <code>weather_info_inserter</code>, pass in the subscriber topic, subscriber, publisher, publisher topic, and the <code>handlerFunc</code> that will be executed when a new message appears on the subscriber topic.</p><p>Finally, we will run the router.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>router</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>NewRouter</span>(<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>RouterConfig</span>{}, <span style=color:#a6e22e>logger</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//SignalsHandler will gracefully shutdown Router when SIGTERM is received
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>AddPlugin</span>(<span style=color:#a6e22e>plugin</span>.<span style=color:#a6e22e>SignalsHandler</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>//The Recoverer middleware handles panics from handlers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>AddMiddleware</span>(<span style=color:#a6e22e>middleware</span>.<span style=color:#a6e22e>Recoverer</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>postgresDB</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>createPostgresConnection</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;added postgres connection and created weather_info table&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>subscriber</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>createSubscriber</span>(<span style=color:#a6e22e>logger</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>publisher</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>createPublisher</span>(<span style=color:#a6e22e>postgresDB</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>AddHandler</span>(
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;weather_info_inserter&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>weather_api_topic</span>, <span style=color:#75715e>//subscriber topic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>subscriber</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>weather_insert_topic</span>, <span style=color:#75715e>//publisher topic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>publisher</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>dbHandler</span>{<span style=color:#a6e22e>db</span>: <span style=color:#a6e22e>postgresDB</span>}.<span style=color:#a6e22e>checkRecordExists</span>,
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=composing-our-docker-container>Composing our Docker Container
<a class=anchor href=#composing-our-docker-container>#</a></h2><p>Almost done! In this section we&rsquo;ll create a docker-compose file in the <code>weather_data</code> directory to run our application.</p><p>The docker-compose file contains three services. The first service is the <code>producer</code> which requires the <code>WAPIKEY</code> environment variable used to call the Weather API. It will also need the <code>ENSIGN_CLIENT_ID</code>, and <code>ENSIGN_CLIENT_SECRET</code> to use Ensign. The second service is the <code>consumer</code> which needs the <code>POSTGRES_USER</code>, <code>POSTGRES_DB</code>, and <code>POSTGRES_PASSWORD</code> environment variables in order to connect to the database and it will also need <code>ENSIGN_CLIENT_ID</code>, and <code>ENSIGN_CLIENT_SECRET</code> to use Ensign. The third service is the <code>postgres</code> database, which is a docker image that will also require the same environment variables as the consumer. You will notice that the container name is <code>weather_db</code>, which is the host name that the consumer application uses to connect to the database and it has also got the same Postgres environment variables as the consumer.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>producer</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>golang:1.19</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>.:/app</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>$GOPATH/pkg/mod:/go/pkg/mod</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>working_dir</span>: <span style=color:#ae81ff>/app/producer/</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>go run main.go</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>WAPIKEY</span>: <span style=color:#ae81ff>${WAPIKEY}</span>
</span></span><span style=display:flex><span>	  <span style=color:#f92672>ENSIGN_CLIENT_ID</span>: <span style=color:#ae81ff>${ENSIGN_CLIENT_ID}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ENSIGN_CLIENT_SECRET</span>: <span style=color:#ae81ff>${ENSIGN_CLIENT_SECRET}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>consumer</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>golang:1.19</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>.:/app</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>$GOPATH/pkg/mod:/go/pkg/mod</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>working_dir</span>: <span style=color:#ae81ff>/app/consumer/</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>go run main.go db.go</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>POSTGRES_USER</span>: <span style=color:#ae81ff>${POSTGRES_USER}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>POSTGRES_DB</span>: <span style=color:#ae81ff>${POSTGRES_DB}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>POSTGRES_PASSWORD</span>: <span style=color:#ae81ff>${POSTGRES_PASSWORD}</span>
</span></span><span style=display:flex><span>	  <span style=color:#f92672>ENSIGN_CLIENT_ID</span>: <span style=color:#ae81ff>${ENSIGN_CLIENT_ID}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ENSIGN_CLIENT_SECRET</span>: <span style=color:#ae81ff>${ENSIGN_CLIENT_SECRET}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>postgres</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres:12</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>5432</span>:<span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>weather_db</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>POSTGRES_USER</span>: <span style=color:#ae81ff>${POSTGRES_USER}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>POSTGRES_DB</span>: <span style=color:#ae81ff>${POSTGRES_DB}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>POSTGRES_PASSWORD</span>: <span style=color:#ae81ff>${POSTGRES_PASSWORD}</span>
</span></span></code></pre></div><h2 id=lets-gooooooooo>Let&rsquo;s Gooooooooo
<a class=anchor href=#lets-gooooooooo>#</a></h2><p>We made it to the end! Once you have all of the code in place, run the following commands on the terminal in the <code>producer</code> and <code>consumer</code> directories:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go mod init
</span></span><span style=display:flex><span>go mod tidy
</span></span></code></pre></div><p>This will create the <code>go.mod</code> and the <code>go.sum</code> files in both directories. Next, move up to the <code>weather_data</code> directory and run the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose up
</span></span></code></pre></div><p>You will see all the applications running and messages printing to the screen.</p><p><img src=/img/weather_app.png alt=weather_app></p><p>On a separate terminal window, run the following command to view the contents of the <code>weather_info</code> table:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose exec weather_db psql -U $POSTGRES_USER -d $POSTGRES_DB -c <span style=color:#e6db74>&#39;select * from weather_info;&#39;</span>
</span></span></code></pre></div><p><img src=/img/database_record.png alt=database_record></p><h2 id=next-steps>Next Steps
<a class=anchor href=#next-steps>#</a></h2><p>Hopefully running this example gives you a general idea on how to build an event-driven application using Watermill and Ensign. You can modify this example slightly and have the Ensign consumer do the entire work of checking and inserting new weather records into the database (replace the handler with a <code>NoPublisherHandler</code>), but remember that loose coupling is the name of the game with event driven architectures! You can also challenge yourself by creating a consumer that takes the records produced by the publisher and updates a front end application with the latest weather data&mldr;</p><p>Let us know (<a href=mailto:info@rotational.io>info@rotational.io</a>) what you end up making with Ensign!</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/rotationalio/ensign/commit/06e2ac936bfc263c448b792534e8dfe766b1d27e title='Last modified by pdamodaran | Feb 3, 2023' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>Feb 3, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/rotationalio/ensign/edit/main/docs/content/examples/data_engineers.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#ensign-for-data-engineers>Ensign for Data Engineers</a><ul><li><a href=#etl-design>ETL Design</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#project-setup>Project Setup</a></li><li><a href=#create-the-ensign-publisher>Create the Ensign Publisher</a><ul><li><a href=#call-the-weather-api>Call the Weather API</a></li><li><a href=#publish-the-data-to-a-topic>Publish the Data to a Topic</a></li><li><a href=#start-the-first-stream>Start the First Stream</a></li></ul></li><li><a href=#create-the-ensign-subscriber>Create the Ensign Subscriber</a><ul><li><a href=#connect-to-the-database>Connect to the Database</a></li><li><a href=#does-the-record-exist>Does the Record Exist?</a></li></ul></li><li><a href=#prepping-the-database>Prepping the Database</a><ul><li><a href=#inserting-new-data>Inserting New Data</a></li><li><a href=#start-the-second-stream>Start the Second Stream</a></li></ul></li><li><a href=#composing-our-docker-container>Composing our Docker Container</a></li><li><a href=#lets-gooooooooo>Let&rsquo;s Gooooooooo</a></li><li><a href=#next-steps>Next Steps</a></li></ul></li></ul></nav></div></aside></main></body></html>